<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âš½ HalÄ± Saha App</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f9f9f9;text-align:center;}
header{background:#2b6cb0;color:white;padding:15px;font-size:22px;}
nav{display:flex;justify-content:center;gap:10px;margin:15px;flex-wrap:wrap;}
button{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
button:hover{opacity:0.9;}
.primary{background:#3182ce;color:white;}
.secondary{background:#e2e8f0;}
section{display:none;}
#map{height:400px;margin:10px auto;width:90%;border-radius:10px;}
.card{background:white;margin:10px auto;padding:15px;width:90%;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,select{padding:8px;margin:5px;width:80%;border-radius:6px;border:1px solid #ccc;}
h3{margin-top:0;}
label{display:block;margin:5px;}
</style>
</head>
<body>

<header>âš½ HalÄ± Saha App</header>

<!-- Login / Register -->
<section id="login">
  <div class="card">
    <h3>GiriÅŸ Yap / KayÄ±t Ol</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Åifre" />
    <button class="primary" id="loginBtn">GiriÅŸ Yap</button>
    <button class="secondary" id="registerBtn">KayÄ±t Ol</button>
  </div>
</section>

<!-- Ana sayfa -->
<section id="main">
<nav>
    <button class="secondary" id="btnBul">HalÄ± Saha Bul</button>
    <button class="secondary" id="btnKatil">MaÃ§a KatÄ±l</button>
    <button class="primary" id="btnOlustur">MaÃ§ OluÅŸtur</button>
    <button class="secondary" id="btnProfil">Profil / MaÃ§larÄ±m</button>
    <button class="secondary" id="btnLogout">Ã‡Ä±kÄ±ÅŸ Yap</button>
</nav>

<!-- HalÄ± Saha Bul -->
<section id="bul">
  <label>Ä°lÃ§e filtrele:
    <select id="filtreIlce">
      <option value="">TÃ¼m Ä°lÃ§eler</option>
      <option value="KadÄ±kÃ¶y">KadÄ±kÃ¶y</option>
      <option value="BeÅŸiktaÅŸ">BeÅŸiktaÅŸ</option>
      <option value="ÅiÅŸli">ÅiÅŸli</option>
      <option value="BakÄ±rkÃ¶y">BakÄ±rkÃ¶y</option>
    </select>
  </label>
  <label><input type="checkbox" id="filtreBosPozisyon"/> Sadece eksik pozisyonlarÄ± gÃ¶ster</label>
  <div id="map"></div>
</section>

<!-- MaÃ§a KatÄ±l -->
<section id="katil">
  <label>Ä°lÃ§e filtrele:
    <select id="katilFiltreIlce">
      <option value="">TÃ¼m Ä°lÃ§eler</option>
      <option value="KadÄ±kÃ¶y">KadÄ±kÃ¶y</option>
      <option value="BeÅŸiktaÅŸ">BeÅŸiktaÅŸ</option>
      <option value="ÅiÅŸli">ÅiÅŸli</option>
      <option value="BakÄ±rkÃ¶y">BakÄ±rkÃ¶y</option>
    </select>
  </label>
  <label><input type="checkbox" id="katilFiltreBosPozisyon"/> Sadece eksik pozisyonlarÄ± gÃ¶ster</label>
  <div id="katilListesi"></div>
</section>

<!-- MaÃ§ OluÅŸtur -->
<section id="olustur">
  <div class="card">
    <h3>Yeni MaÃ§ OluÅŸtur</h3>
    <input id="saha" placeholder="HalÄ± Saha AdÄ±" />
    <input id="ilce" placeholder="Ä°lÃ§e / Semt" />
    <input id="saat" placeholder="Saat (20:00)" />
    <input id="eksik" placeholder="Eksik pozisyon" />
    <input id="kackisi" type="number" placeholder="KaÃ§ kiÅŸi lazÄ±m?" />
    <p>ğŸ“ Haritaya tÄ±klayarak saha konumunu seÃ§in</p>
    <button class="primary" id="kaydetBtn">MaÃ§Ä± Kaydet</button>
  </div>
</section>

<!-- Profil / MaÃ§larÄ±m -->
<section id="profil">
  <h3>MaÃ§larÄ±m</h3>
  <div id="profilListesi"></div>
</section>

</section>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyB8-N4sVBtxIoZqikRhGoXv86YU_9K8ecA",
  authDomain: "halisaha-1537c.firebaseapp.com",
  projectId: "halisaha-1537c",
  storageBucket: "halisaha-1537c.firebasestorage.app",
  messagingSenderId: "110810439295",
  appId: "1:110810439295:web:656f99f060ebfa88ba694a",
  measurementId: "G-QQH8205FB0"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Global deÄŸiÅŸkenler
let currentUser = null;
let map = null;
let secilenMarker = null;
let secilenCoord = null;

// Login ve register
document.getElementById("loginBtn").onclick = async ()=>{
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  try{
    const userCredential = await auth.signInWithEmailAndPassword(email,password);
    currentUser=userCredential.user;
    sessionStorage.setItem("userEmail",currentUser.email);
    initMain();
  }catch(e){alert("GiriÅŸ baÅŸarÄ±sÄ±z: "+e.message);}
}
document.getElementById("registerBtn").onclick = async ()=>{
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  try{
    const userCredential = await auth.createUserWithEmailAndPassword(email,password);
    currentUser=userCredential.user;
    await db.collection("users").doc(currentUser.uid).set({email:currentUser.email});
    sessionStorage.setItem("userEmail",currentUser.email);
    initMain();
  }catch(e){alert("KayÄ±t baÅŸarÄ±sÄ±z: "+e.message);}
}

// Ana sayfayÄ± baÅŸlat
function initMain(){
  document.getElementById("login").style.display="none";
  document.getElementById("main").style.display="block";

  // Buton eventleri
  document.getElementById("btnBul").onclick=()=>showSection("bul");
  document.getElementById("btnKatil").onclick=()=>showSection("katil");
  document.getElementById("btnOlustur").onclick=()=>showSection("olustur");
  document.getElementById("btnProfil").onclick=()=>showSection("profil");
  document.getElementById("btnLogout").onclick=()=>logout();

  // Harita baÅŸlat
  if(!map){
    map=L.map('map').setView([41.0082,28.9784],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    map.on('click',function(e){
      if(secilenMarker) map.removeLayer(secilenMarker);
      secilenCoord=e.latlng;
      secilenMarker=L.marker(e.latlng).addTo(map).bindPopup("SeÃ§ilen Saha").openPopup();
    });
  }

  // Filtre eventleri
  document.getElementById("filtreIlce").onchange = maclariGetir;
  document.getElementById("filtreBosPozisyon").onchange = maclariGetir;
  document.getElementById("katilFiltreIlce").onchange = maclariKatilGetir;
  document.getElementById("katilFiltreBosPozisyon").onchange = maclariKatilGetir;

  showSection("bul");
  maclariGetir();
}

// Logout
function logout(){
  auth.signOut();
  currentUser=null;
  sessionStorage.removeItem("userEmail");
  location.reload();
}

// BÃ¶lÃ¼m geÃ§iÅŸi
function showSection(id){
  document.querySelectorAll("#main section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  if(id==="bul") maclariGetir();
  if(id==="katil") maclariKatilGetir();
  if(id==="profil") profilGetir();
}

// MaÃ§ oluÅŸtur
document.getElementById("kaydetBtn").onclick=async function(){
  const saha=document.getElementById("saha").value;
  const ilce=document.getElementById("ilce").value;
  const saat=document.getElementById("saat").value;
  const eksik=document.getElementById("eksik").value;
  const kackisi=document.getElementById("kackisi").value;
  if(!saha||!saat||!secilenCoord){return alert("Saha, saat ve konumu girin!");}
  await db.collection("maclar").add({
    saha,saat,eksik,kackisi,ilce,
    lat:secilenCoord.lat,lng:secilenCoord.lng,
    olusturan:currentUser.email,
    katilanlar:[]
  });
  alert("MaÃ§ kaydedildi!");
  document.getElementById("saha").value='';
  document.getElementById("saat").value='';
  document.getElementById("eksik").value='';
  document.getElementById("kackisi").value='';
  document.getElementById("ilce").value='';
  if(secilenMarker) map.removeLayer(secilenMarker);
  secilenCoord=null;
  showSection("bul");
}

// HalÄ± Saha Bul
async function maclariGetir(){
  const filtreIlce=document.getElementById("filtreIlce").value;
  const bosPozisyon=document.getElementById("filtreBosPozisyon").checked;
  map.eachLayer(l=>{if(l instanceof L.Marker) map.removeLayer(l);});
  const snapshot=await db.collection("maclar").get();
  snapshot.forEach(doc=>{
    const mac=doc.data();
    if((!filtreIlce||mac.ilce===filtreIlce)&&(!bosPozisyon||mac.eksik)){
      if(mac.lat && mac.lng){
        L.marker([mac.lat,mac.lng]).addTo(map)
          .bindPopup(`<b>${mac.saha}</b><br>${mac.saat}<br>${mac.ilce}`);
      }
    }
  });
}

// MaÃ§a KatÄ±l
async function maclariKatilGetir(){
  const filtreIlce=document.getElementById("katilFiltreIlce").value;
  const bosPozisyon=document.getElementById("katilFiltreBosPozisyon").checked;
  const container=document.getElementById("katilListesi");
  container.innerHTML="";
  const snapshot=await db.collection("maclar").get();
  snapshot.forEach(doc=>{
    const mac=doc.data();
    if((!filtreIlce||mac.ilce===filtreIlce)&&(!bosPozisyon||mac.eksik)){
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <h3>${mac.saha}</h3>
        <p>ğŸ•’ Saat: ${mac.saat}</p>
        <p>ğŸ§¤ Eksik: ${mac.eksik||"Yok"}</p>
        <p>ğŸ‘¥ KiÅŸi lazÄ±m: ${mac.kackisi||"BelirtilmemiÅŸ"}</p>
        <p>ğŸ“ Ä°lÃ§e: ${mac.ilce||"BelirtilmemiÅŸ"}</p>
        <button class="primary">KatÄ±l</button>
      `;
      container.appendChild(card);
      card.querySelector("button").onclick=async ()=>{
        if(!mac.katilanlar.includes(currentUser.email)){
          mac.katilanlar.push(currentUser.email);
          await db.collection("maclar").doc(doc.id).update({katilanlar:mac.katilanlar});
          alert("MaÃ§a katÄ±ldÄ±nÄ±z!");
          maclariKatilGetir();
        } else { alert("Zaten katÄ±lmÄ±ÅŸsÄ±nÄ±z!"); }
      }
    }
  });
}

// Profil / MaÃ§larÄ±m
async function profilGetir(){
  const container=document.getElementById("profilListesi");
  container.innerHTML="";
  const snapshot=await db.collection("maclar").get();
  snapshot.forEach(doc=>{
    const mac=doc.data();
    if(mac.olusturan===currentUser.email || mac.katilanlar.includes(currentUser.email)){
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <h3>${mac.saha}</h3>
        <p>ğŸ•’ Saat: ${mac.saat}</p>
        <p>ğŸ§¤ Eksik: ${mac.eksik || "Yok"}</p>
        <p>ğŸ‘¥ KiÅŸi lazÄ±m: ${mac.kackisi || "BelirtilmemiÅŸ"}</p>
        <p>ğŸ“ Ä°lÃ§e: ${mac.ilce || "BelirtilmemiÅŸ"}</p>
        <p>ğŸ§‘ KatÄ±lanlar: ${mac.katilanlar.join(", ")}</p>
        <p>ğŸ”¹ OluÅŸturan: ${mac.olusturan}</p>
      `;
      container.appendChild(card);
    }
  });
}

</script>
</body>
</html>
