<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Halı Saha Bul — Katılım Onayı</title>
  <style>
    :root{--green:#1f9d6a;--dark:#09311a;--card:#fff;--muted:#666}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Arial;margin:0;background:#eef9f1;color:#0b2a17}
    header{background:var(--green);color:white;padding:16px 12px;text-align:center;font-size:20px;font-weight:700}
    .wrap{max-width:980px;margin:18px auto;padding:0 12px}
    .auth, .menu, .content{margin-bottom:16px}
    input, select{padding:8px;border-radius:8px;border:1px solid #dfe9e2;margin:6px 0;width:100%;box-sizing:border-box}
    button{background:var(--green);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;color:var(--green);border:1px solid var(--green)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .card{background:var(--card);box-shadow:0 4px 14px rgba(7,30,15,0.06);border-radius:10px;padding:12px;margin-bottom:12px}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:13px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:8px;background:#fff;border:1px solid #e6efe7;cursor:pointer}
    .tab.active{background:var(--green);color:white}
    .match-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .danger{background:#e74c3c}
    .ok{background:#2ecc71}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#f0fdf4;color:#065f46;font-weight:600;font-size:12px}
    pre{white-space:pre-wrap;word-wrap:break-word}
  </style>
</head>
<body>
  <header>⚽ Halı Saha Bul — Katılım & Onay Sistemi</header>
  <div class="wrap">

    <!-- AUTH -->
    <div id="authWrap" class="card auth">
      <div id="authUi">
        <div class="row">
          <input id="email" placeholder="E-posta (ör: isim@mail.com)"/>
          <input id="password" type="password" placeholder="Şifre (en az 6 karakter)"/>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnLogin">Giriş Yap</button>
          <button id="btnSignup" class="ghost">Kayıt Ol</button>
        </div>
        <div class="muted" style="margin-top:8px">Not: Email/Password auth Firebase konsolunda etkin olmalı.</div>
      </div>

      <div id="userUi" style="display:none">
        <div class="row" style="align-items:center;justify-content:space-between">
          <div>
            <div id="userEmail" style="font-weight:700"></div>
            <div class="muted small" id="userStatus">Giriş başarılı</div>
          </div>
          <div>
            <button id="btnLogout" class="ghost">Çıkış Yap</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MENU -->
    <div id="menuWrap" class="menu" style="display:none">
      <div class="tabs">
        <div class="tab active" data-tab="list" id="tabList">Maç Listesi</div>
        <div class="tab" data-tab="create" id="tabCreate">Maç Oluştur</div>
        <div class="tab" data-tab="requests" id="tabRequests">Katılım İstekleri</div>
        <div class="tab" data-tab="mymatches" id="tabMyMatches">Maçlarım</div>
      </div>
    </div>

    <!-- CONTENT -->
    <div id="content" class="content card">
      <div id="listView">
        <h3>Maç Listesi</h3>
        <div id="matchesContainer"></div>
      </div>

      <div id="createView" style="display:none">
        <h3>Yeni Maç Oluştur</h3>
        <div class="row">
          <input id="createSaha" placeholder="Saha adı / adres" />
          <input id="createSaat" placeholder="Saat (ör: 20:00)" />
          <input id="createKontenjan" type="number" placeholder="Kontenjan (örn: 10)" />
        </div>
        <div style="margin-top:8px">
          <button id="btnCreate">Maç Oluştur</button>
        </div>
        <div class="muted small" style="margin-top:8px">
          Oluşturan kullanıcı otomatik olarak <b>katılanlar</b> listesine eklenir.
        </div>
      </div>

      <div id="requestsView" style="display:none">
        <h3>Katılım İstekleri (Sadece maç sahibi görür)</h3>
        <div id="requestsContainer"></div>
      </div>

      <div id="myMatchesView" style="display:none">
        <h3>Senin Maçların (oluşturdukların ve katıldıkların)</h3>
        <div id="myMatchesContainer"></div>
      </div>
    </div>

    <div id="debug" class="muted small" style="margin-top:6px"></div>

  </div>

  <script type="module">
  // ---------- FIREBASE IMPORTS ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, arrayUnion, arrayRemove, getDoc, query, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ---------- YOUR FIREBASE CONFIG (you provided) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyB8-N4sVBtxIoZqikRhGoXv86YU_9K8ecA",
    authDomain: "halisaha-1537c.firebaseapp.com",
    projectId: "halisaha-1537c",
    storageBucket: "halisaha-1537c.firebasestorage.app",
    messagingSenderId: "110810439295",
    appId: "1:110810439295:web:656f99f060ebfa88ba694a",
    measurementId: "G-QQH8205FB0"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ---------- DOM ----------
  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");
  const btnLogin = document.getElementById("btnLogin");
  const btnSignup = document.getElementById("btnSignup");
  const btnLogout = document.getElementById("btnLogout");

  const authUi = document.getElementById("authUi");
  const userUi = document.getElementById("userUi");
  const userEmailEl = document.getElementById("userEmail");
  const userStatusEl = document.getElementById("userStatus");

  const menuWrap = document.getElementById("menuWrap");
  const tabs = document.querySelectorAll(".tab");
  const content = document.getElementById("content");

  const matchesContainer = document.getElementById("matchesContainer");
  const requestsContainer = document.getElementById("requestsContainer");
  const myMatchesContainer = document.getElementById("myMatchesContainer");

  const createSaha = document.getElementById("createSaha");
  const createSaat = document.getElementById("createSaat");
  const createKontenjan = document.getElementById("createKontenjan");
  const btnCreate = document.getElementById("btnCreate");

  const debug = document.getElementById("debug");

  // ---------- Helpers ----------
  function elt(tag, className, innerHTML){
    const e = document.createElement(tag);
    if (className) e.className = className;
    if (innerHTML !== undefined) e.innerHTML = innerHTML;
    return e;
  }

  // ---------- AUTH ----------
  btnSignup.addEventListener("click", async () => {
    const email = emailEl.value.trim();
    const pass = passEl.value;
    if (!email || !pass) return alert("E-posta ve şifre girin.");
    try {
      await createUserWithEmailAndPassword(auth, email, pass);
      emailEl.value = ""; passEl.value = "";
    } catch (err) { alert(err.message); console.error(err); }
  });

  btnLogin.addEventListener("click", async () => {
    const email = emailEl.value.trim();
    const pass = passEl.value;
    if (!email || !pass) return alert("E-posta ve şifre girin.");
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      emailEl.value = ""; passEl.value = "";
    } catch (err) { alert(err.message); console.error(err); }
  });

  btnLogout.addEventListener("click", async () => {
    await signOut(auth);
  });

  // Tab switching
  tabs.forEach(t => t.addEventListener("click", () => {
    tabs.forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    showTab(t.dataset.tab);
  }));

  function showTab(tab){
    document.getElementById("listView").style.display = tab === "list" ? "block" : "none";
    document.getElementById("createView").style.display = tab === "create" ? "block" : "none";
    document.getElementById("requestsView").style.display = tab === "requests" ? "block" : "none";
    document.getElementById("myMatchesView").style.display = tab === "mymatches" ? "block" : "none";
  }

  // ---------- Real-time matches listener ----------
  let matchesUnsub = null;
  function startMatchesListener(){
    if (matchesUnsub) return;
    const col = collection(db, "matches");
    matchesUnsub = onSnapshot(col, snapshot => {
      matchesContainer.innerHTML = "";
      snapshot.forEach(docSnap => {
        const id = docSnap.id;
        const m = docSnap.data();
        renderMatchCard(id, m);
      });
    }, err => console.error("matches listen err", err));
  }

  function renderMatchCard(id, m){
    const card = elt("div", "card");
    const titleRow = elt("div", "row");
    titleRow.appendChild(elt("div", "", `<b>${escapeHtml(m.location)}</b>`));
    const capacity = (m.kontenjan || 0);
    const current = (m.players ? m.players.length : 0);
    const remaining = capacity - current;
    const badgeText = remaining <= 0 ? "DOLU" : `${remaining} yer kaldı`;
    const badge = elt("div", "badge", badgeText);
    titleRow.appendChild(badge);
    card.appendChild(titleRow);

    card.appendChild(elt("div","muted small", `Saat: ${escapeHtml(m.time)} — Oluşturan: ${escapeHtml(m.owner||'—')}`));
    card.appendChild(elt("div","muted small", `Eksik/Not: ${escapeHtml(m.note||'—')}`));
    card.appendChild(elt("div","small", `Katılanlar (${current}/${capacity}): ${m.players ? m.players.join(", ") : "-"}`));

    // Actions
    const actions = elt("div", "match-actions");
    // Show Join Request button if not already participant and not requested and space exists
    const user = auth.currentUser;
    if (user) {
      const isOwner = (m.owner === user.email);
      const alreadyPlayer = m.players && m.players.includes(user.email);
      const alreadyRequested = m.requests && m.requests.includes(user.email);

      if (isOwner) {
        actions.appendChild(elt("button","ghost", "Sahipsin (istekleri yönet)")).addEventListener("click", () => {
          // switch to requests tab and filter
          tabs.forEach(x=>x.classList.remove("active"));
          document.getElementById("tabRequests").classList.add("active");
          showTab("requests");
          showRequestsForMatch(id);
        });
      } else {
        if (alreadyPlayer) {
          actions.appendChild(elt("button","ghost","Zaten Katılıyorsun"));
        } else if (alreadyRequested) {
          actions.appendChild(elt("button","ghost","İstek Gönderildi"));
        } else if (remaining <= 0) {
          actions.appendChild(elt("button","ghost","Kontenjan dolu"));
        } else {
          const btn = elt("button", "", "Katılmak İstiyorum");
          btn.addEventListener("click", () => sendJoinRequest(id));
          actions.appendChild(btn);
        }
      }
    } else {
      actions.appendChild(elt("div","muted small","Giriş yapmadan istek gönderemezsin"));
    }

    card.appendChild(actions);
    matchesContainer.appendChild(card);
  }

  // ---------- Send join request ----------
  async function sendJoinRequest(matchId){
    const user = auth.currentUser;
    if (!user) return alert("Önce giriş yapmalısın");
    const mRef = doc(db, "matches", matchId);
    // add to requests array (if not exists)
    await updateDoc(mRef, { requests: arrayUnion(user.email) });
    alert("Katılma isteği gönderildi. Maç sahibi onaylayacak.");
  }

  // ---------- Create match ----------
  btnCreate.addEventListener("click", async () => {
    const owner = auth.currentUser;
    if (!owner) return alert("Önce giriş yapmalısın");
    const location = createSaha.value.trim();
    const time = createSaat.value.trim();
    const kont = parseInt(createKontenjan.value, 10) || 0;
    if (!location || !time || kont <= 0) return alert("Lütfen saha, saat ve pozitif bir kontenjan girin.");

    // create match doc
    const docRef = await addDoc(collection(db, "matches"), {
      owner: owner.email,
      location,
      time,
      kontenjan: kont,
      players: [owner.email], // owner auto joins
      requests: [],
      note: ""
    });

    // also add to user's document (users collection)
    const userRef = doc(db, "users", owner.uid);
    await updateDocSafeAdd(userRef, { email: owner.email, maclarim: arrayUnion(docRef.id) });

    alert("Maç oluşturuldu ✅");
    createSaha.value = ""; createSaat.value = ""; createKontenjan.value = "";
  });

  // helper: updateDoc but create document if missing
  async function updateDocSafeAdd(docRef, data){
    try {
      await updateDoc(docRef, data);
    } catch (err) {
      // if doc doesn't exist, set it with provided fields (Firestore's set not imported; we can use addDoc to users collection with ID)
      // but easier: use set via updateDoc failing—so fallback: create with addDoc in users collection with id? we want doc id = uid
      // import setDoc
      // To avoid heavy imports here, we'll attempt to set by re-importing setDoc:
      const { setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      await setDoc(docRef, data, { merge: true });
    }
  }

  // ---------- Requests management (owner) ----------
  async function showRequestsForMatch(matchId){
    requestsContainer.innerHTML = "";
    const mRef = doc(db, "matches", matchId);
    const snap = await getDocSafe(mRef);
    if (!snap) { requestsContainer.innerText = "Maç bulunamadı"; return; }
    const m = snap.data();
    requestsContainer.appendChild(elt("div","muted small", `Maç: ${m.location} — Saat: ${m.time}`));
    const requests = m.requests || [];
    if (!requests.length) {
      requestsContainer.appendChild(elt("div","muted small","Henüz istek yok"));
      return;
    }
    requests.forEach(email => {
      const row = elt("div","card");
      row.appendChild(elt("div","small", `<b>${escapeHtml(email)}</b>`));
      const actions = elt("div","match-actions");
      const approve = elt("button","ok","Onayla");
      const reject = elt("button","danger","Reddet");
      approve.addEventListener("click", async ()=>{
        // approve: move email from requests -> players, add matchId to user's maclarim
        const mDoc = await getDocSafe(mRef);
        const mdata = mDoc.data();
        const capacity = mdata.kontenjan || 0;
        const current = (mdata.players||[]).length;
        if (current >= capacity) return alert("Kontenjan dolu — onaylayamazsın");
        await updateDoc(mRef, { players: arrayUnion(email), requests: arrayRemove(email) });
        // add to user's doc
        const userQuery = query(collection(db, "users"), where("email", "==", email));
        const userSnap = await getDocs(userQuery);
        if (!userSnap.empty) {
          userSnap.forEach(uDoc => updateDocSafeAdd(doc(db,"users",uDoc.id), { maclarim: arrayUnion(mRef.id) }));
        } else {
          // create user doc with email and maclarim
          const { setDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
          const newUserRef = doc(db, "users", email); // use email as id fallback
          await setDoc(newUserRef, { email, maclarim: [mRef.id] }, { merge: true });
        }
        alert(`${email} onaylandı`);
        // refresh requests view for this match
        showRequestsForMatch(matchId);
      });
      reject.addEventListener("click", async ()=>{
        await updateDoc(mRef, { requests: arrayRemove(email) });
        alert(`${email} reddedildi`);
        showRequestsForMatch(matchId);
      });
      actions.appendChild(approve);
      actions.appendChild(reject);
      row.appendChild(actions);
      requestsContainer.appendChild(row);
    });
  }

  // helper: safe getDoc
  async function getDocSafe(docRef){
    try {
      const { getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
      const snap = await getDoc(docRef);
      return snap.exists() ? snap : null;
    } catch (err){
      console.error(err);
      return null;
    }
  }

  // ---------- My Matches (created & joined) ----------
  async function renderMyMatches(){
    myMatchesContainer.innerHTML = "";
    const user = auth.currentUser;
    if (!user) { myMatchesContainer.innerText = "Giriş yapmalısın"; return; }
    const q = collection(db, "matches");
    const snap = await getDocs(q);
    const created = [];
    const joined = [];
    snap.forEach(d => {
      const m = d.data(); m._id = d.id;
      if (m.owner === user.email) created.push(m);
      if (m.players && m.players.includes(user.email)) joined.push(m);
    });

    myMatchesContainer.appendChild(elt("div","","<b>Oluşturdukların</b>"));
    if (!created.length) myMatchesContainer.appendChild(elt("div","muted small","Henüz oluşturduğun maç yok"));
    created.forEach(m => {
      const c = elt("div","card");
      c.innerHTML = `<b>${escapeHtml(m.location)}</b><div class="muted small">Saat: ${escapeHtml(m.time)} - ${m.players.length}/${m.kontenjan}</div>`;
      myMatchesContainer.appendChild(c);
    });

    myMatchesContainer.appendChild(elt("div","","<b>Katıldıkların</b>"));
    if (!joined.length) myMatchesContainer.appendChild(elt("div","muted small","Henüz katıldığın maç yok"));
    joined.forEach(m => {
      const c = elt("div","card");
      c.innerHTML = `<b>${escapeHtml(m.location)}</b><div class="muted small">Saat: ${escapeHtml(m.time)} - ${m.players.length}/${m.kontenjan}</div>`;
      myMatchesContainer.appendChild(c);
    });
  }

  // real-time requests listener for all matches owned by current user (so owner sees changes live)
  let requestsUnsub = null;
  async function startRequestsListenerForUser(userEmail){
    // unsubscribe old
    if (requestsUnsub) requestsUnsub();
    const col = collection(db, "matches");
    requestsUnsub = onSnapshot(col, snapshot => {
      // only refresh requests view if it's open
      if (document.querySelector(".tab.active")?.dataset.tab === "requests") {
        // if requests are open with a specific match, keep current view; else show aggregate
        requestsContainer.innerHTML = "";
        snapshot.forEach(d => {
          const m = d.data();
          if (m.owner === userEmail && (m.requests && m.requests.length)) {
            const card = elt("div","card");
            card.appendChild(elt("div","","<b>"+escapeHtml(m.location)+"</b>"));
            card.appendChild(elt("div","muted small","Saat: "+escapeHtml(m.time)));
            card.appendChild(elt("div","small","İstek sayısı: "+ (m.requests.length || 0)));
            const btn = elt("button","","İstekleri Yönet");
            btn.addEventListener("click", ()=> showRequestsForMatch(d.id));
            card.appendChild(btn);
            requestsContainer.appendChild(card);
          }
        });
        if (!requestsContainer.innerHTML) requestsContainer.appendChild(elt("div","muted small","Henüz onay bekleyen istek yok"));
      }
    }, err=>console.error(err));
  }

  // ---------- onAuth değişikliği ----------
  onAuthStateChanged(auth, user => {
    if (user) {
      authUi.style.display = "none";
      userUi.style.display = "block";
      userEmailEl.textContent = user.email;
      menuWrap.style.display = "block";
      debug.textContent = `UID: ${user.uid} — Email: ${user.email}`;

      // start matches listener
      startMatchesListener();

      // start requests listener for this user (owner)
      startRequestsListenerForUser(user.email);

      // update my matches whenever matches change
      // simple approach: re-render my matches on every match change
      // we can reuse matchesUnsub by hooking into same snapshot callbacks; but easier: on each snapshot event we call renderMyMatches
      // listen matches collection and call renderMyMatches
      // but to avoid multiple listeners, we'll just call renderMyMatches on a small interval or after relevant ops — we'll call it each time matches listener runs:
      const col = collection(db, "matches");
      // add a listener that triggers myMatches update
      onSnapshot(col, () => {
        renderMyMatches();
      });

    } else {
      authUi.style.display = "block";
      userUi.style.display = "none";
      menuWrap.style.display = "none";
      debug.textContent = "";
      // unsubscribe listeners if any
      if (matchesUnsub) { matchesUnsub(); matchesUnsub = null; }
      if (requestsUnsub) { requestsUnsub(); requestsUnsub = null; }
    }
  });

  // ---------- Small helper ----------
  function escapeHtml(s){
    if (!s && s!==0) return "";
    return String(s).replace(/[&<>"'\/]/g, function (c) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;",'/':'&#47;'}[c];
    });
  }

  // ---------- initial view ----------
  showTab("list");

  </script>
</body>
</html>

