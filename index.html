<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>⚽ Halı Saha App</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body{font-family:Arial,sans-serif;margin:0;background:#f9f9f9;text-align:center;}
header{background:#2b6cb0;color:white;padding:15px;font-size:22px;}
nav{display:flex;justify-content:center;gap:10px;margin:15px;flex-wrap:wrap;}
button{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
button:hover{opacity:0.9;}
.primary{background:#3182ce;color:white;}
.secondary{background:#e2e8f0;}
section{display:none;}
#map{height:400px;margin:10px auto;width:90%;border-radius:10px;}
.card{background:white;margin:10px auto;padding:15px;width:90%;border-radius:10px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
input,select{padding:8px;margin:5px;width:80%;border-radius:6px;border:1px solid #ccc;}
h3{margin-top:0;}
label{display:block;margin:5px;}
</style>
</head>
<body>

<header>⚽ Halı Saha App</header>

<!-- LOGIN -->
<section id="loginSection">
  <div class="card">
    <h3>Giriş Yap / Kayıt Ol</h3>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Şifre" />
    <button class="primary" id="loginBtn">Giriş Yap</button>
    <button class="secondary" id="registerBtn">Kayıt Ol</button>
  </div>
</section>

<!-- ANA MENÜ -->
<section id="menuSection">
  <nav>
    <button class="secondary" id="btnBul">Halı Saha Bul</button>
    <button class="secondary" id="btnKatil">Maça Katıl</button>
    <button class="primary" id="btnOlustur">Maç Oluştur</button>
    <button class="secondary" id="btnProfil">Profil / Maçlarım</button>
    <button class="secondary" id="btnLogout">Çıkış Yap</button>
  </nav>
</section>

<!-- HALI SAHA BUL -->
<section id="bulSection">
  <label>İlçe filtrele:
    <select id="filtreIlce">
      <option value="">Tüm İlçeler</option>
      <option value="Kadıköy">Kadıköy</option>
      <option value="Beşiktaş">Beşiktaş</option>
      <option value="Şişli">Şişli</option>
      <option value="Bakırköy">Bakırköy</option>
    </select>
  </label>
  <label><input type="checkbox" id="filtreBosPozisyon"/> Sadece eksik pozisyonları göster</label>
  <div id="map"></div>
</section>

<!-- MAÇA KATIL -->
<section id="katilSection">
  <label>İlçe filtrele:
    <select id="katilFiltreIlce">
      <option value="">Tüm İlçeler</option>
      <option value="Kadıköy">Kadıköy</option>
      <option value="Beşiktaş">Beşiktaş</option>
      <option value="Şişli">Şişli</option>
      <option value="Bakırköy">Bakırköy</option>
    </select>
  </label>
  <label><input type="checkbox" id="katilFiltreBosPozisyon"/> Sadece eksik pozisyonları göster</label>
  <div id="katilListesi"></div>
</section>

<!-- MAÇ OLUŞTUR -->
<section id="olusturSection">
  <div class="card">
    <h3>Yeni Maç Oluştur</h3>
    <input id="saha" placeholder="Halı Saha Adı" />
    <input id="ilce" placeholder="İlçe / Semt" />
    <input id="saat" placeholder="Saat (20:00)" />
    <input id="eksik" placeholder="Eksik pozisyon" />
    <input id="kackisi" type="number" placeholder="Kaç kişi lazım?" />
    <p>📍 Haritaya tıklayarak saha konumunu seçin</p>
    <button class="primary" id="kaydetBtn">Maçı Kaydet</button>
  </div>
</section>

<!-- PROFİL -->
<section id="profilSection">
  <h3>Maçlarım</h3>
  <div id="profilListesi"></div>
</section>

<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyB8-N4sVBtxIoZqikRhGoXv86YU_9K8ecA",
  authDomain: "halisaha-1537c.firebaseapp.com",
  projectId:"halisaha-1537c",
  storageBucket: "halisaha-1537c.firebasestorage.app",
  messagingSenderId:"110810439295",
  appId:"1:110810439295:web:656f99f060ebfa88ba694a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser=null;
let map=null;
let secilenMarker=null;
let secilenCoord=null;

// LOGIN / REGISTER
document.getElementById("loginBtn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    const userCredential = await auth.signInWithEmailAndPassword(email,password);
    currentUser = userCredential.user;
    initApp();
  } catch(e){ alert("Giriş başarısız: "+e.message);}
}
document.getElementById("registerBtn").onclick = async () => {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email,password);
    currentUser = userCredential.user;
    await db.collection("users").doc(currentUser.uid).set({email:currentUser.email});
    initApp();
  } catch(e){ alert("Kayıt başarısız: "+e.message);}
}

// ANA UYGULAMA
function initApp(){
  showSection("menuSection");
  initMap();
  maclariGetir();
  maclariKatilGetir();

  document.getElementById("btnBul").onclick = ()=>{showSection("bulSection"); maclariGetir();}
  document.getElementById("btnKatil").onclick = ()=>{showSection("katilSection"); maclariKatilGetir();}
  document.getElementById("btnOlustur").onclick = ()=>showSection("olusturSection");
  document.getElementById("btnProfil").onclick = ()=>{showSection("profilSection"); profilGetir();}
  document.getElementById("btnLogout").onclick = ()=>{auth.signOut(); location.reload();}

  document.getElementById("filtreIlce").onchange = maclariGetir;
  document.getElementById("filtreBosPozisyon").onchange = maclariGetir;
  document.getElementById("katilFiltreIlce").onchange = maclariKatilGetir;
  document.getElementById("katilFiltreBosPozisyon").onchange = maclariKatilGetir;
}

// SHOW / HIDE
function showSection(id){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

// HARİTA
function initMap(){
  if(map) return;
  map=L.map('map').setView([41.0082,28.9784],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors'
  }).addTo(map);
  map.on('click',function(e){
    if(secilenMarker) map.removeLayer(secilenMarker);
    secilenCoord = e.latlng;
    secilenMarker = L.marker(e.latlng).addTo(map).bindPopup("Seçilen Saha").openPopup();
  });
}

// MAÇ OLUŞTUR
document.getElementById("kaydetBtn").onclick = async ()=> {
  const saha=document.getElementById("saha").value;
  const ilce=document.getElementById("ilce").value;
  const saat=document.getElementById("saat").value;
  const eksik=document.getElementById("eksik").value;
  const kackisi=document.getElementById("kackisi").value;
  if(!saha || !saat || !secilenCoord) return alert("Saha, saat ve konumu girin!");
  await db.collection("maclar").add({
    saha,saat,eksik,kackisi,ilce,
    lat:secilenCoord.lat,
    lng:secilenCoord.lng,
    olusturan:currentUser.email,
    katilanlar:[]
  });
  alert("Maç kaydedildi!");
  document.getElementById("saha").value='';
  document.getElementById("ilce").value='';
  document.getElementById("saat").value='';
  document.getElementById("eksik").value='';
  document.getElementById("kackisi").value='';
  if(secilenMarker) map.removeLayer(secilenMarker);
  secilenCoord=null;
  maclariGetir();
  maclariKatilGetir();
}

// MAÇLARI GETİR (HARİTA)
async function maclariGetir(){
  if(!map) initMap();
  const ilceFiltre=document.getElementById("filtreIlce").value;
  const bosPozisyon=document.getElementById("filtreBosPozisyon").checked;
  const snapshot=await db.collection("maclar").get();
  
  snapshot.forEach(doc=>{
    const mac=doc.data();
    if(ilceFiltre && mac.ilce!==ilceFiltre) return;
    if(bosPozisyon && !mac.eksik) return;
    L.marker([mac.lat,mac.lng]).addTo(map)
      .bindPopup(`<b>${mac.saha}</b><br>${mac.saat}<br>Eksik: ${mac.eksik||"Yok"}`);
  });
}

// MAÇA KATIL
async function maclariKatilGetir(){
  const container=document.getElementById("katilListesi");
  container.innerHTML='';
  const ilceFiltre=document.getElementById("katilFiltreIlce").value;
  const bosPozisyon=document.getElementById("katilFiltreBosPozisyon").checked;
  const snapshot=await db.collection("maclar").get();
  
  snapshot.forEach(doc=>{
    const mac=doc.data();
    if(ilceFiltre && mac.ilce!==ilceFiltre) return;
    if(bosPozisyon && !mac.eksik) return;
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<h3>${mac.saha}</h3>
      <p>🕒 Saat: ${mac.saat}</p>
      <p>🧤 Eksik: ${mac.eksik||"Yok"}</p>
      <p>👥 Kişi lazım: ${mac.kackisi||"Belirtilmemiş"}</p>
      <p>📍 İlçe: ${mac.ilce||"Belirtilmemiş"}</p>
      <button class="primary">Katıl</button>`;
    container.appendChild(card);

    card.querySelector("button").onclick = async () => {
      if(!mac.katilanlar.includes(currentUser.email)){
        mac.katilanlar.push(currentUser.email);
        await db.collection("maclar").doc(doc.id).update({katilanlar:mac.katilanlar});
        alert("Maça katıldınız!");
        maclariKatilGetir();
      } else {
        alert("Zaten katılmışsınız!");
      }
    }
  });
}

// PROFİL / MAÇLARIM
async function profilGetir(){
  const container=document.getElementById("profilListesi");
  container.innerHTML='';
  const snapshot=await db.collection("maclar").get();
  snapshot.forEach(doc=>{
    const mac=doc.data();
    if(mac.olusturan===currentUser.email || mac.katilanlar.includes(currentUser.email)){
      const card=document.createElement("div"); card.className="card";
      card.innerHTML=`<h3>${mac.saha}</h3>
        <p>🕒 Saat: ${mac.saat}</p>
        <p>🧤 Eksik: ${mac.eksik||"Yok"}</p>
        <p>👥 Kişi lazım: ${mac.kackisi||"Belirtilmemiş"}</p>
        <p>📍 İlçe: ${mac.ilce||"Belirtilmemiş"}</p>
        <p>🧑 Katılanlar: ${mac.katilanlar.join(", ")}</p>
        <p>🔹 Oluşturan: ${mac.olusturan}</p>`;
      container.appendChild(card);
    }
  });
}

// Sayfa açılırken login göster
showSection("loginSection");
</script>
</body>
</html>
